<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="generator" content="Observable Framework v1.13.3">
<title>Lab 2: Subway Staffing | Interactive Data Visualization (Fall 2025)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="../_observablehq/theme-air,near-midnight.dcdbf18e.css">
<link rel="preload" as="style" href="../_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="../_observablehq/theme-air,near-midnight.dcdbf18e.css">
<link rel="stylesheet" type="text/css" href="../_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="modulepreload" href="../_observablehq/client.609bff7d.js">
<link rel="modulepreload" href="../_observablehq/runtime.e080113b.js">
<link rel="modulepreload" href="../_observablehq/stdlib.d2092143.js">
<link rel="modulepreload" href="../_observablehq/stdlib/inputs.a73cd26a.js">
<link rel="modulepreload" href="../_npm/htl@0.3.1/72f4716c.js">
<link rel="modulepreload" href="../_npm/isoformat@0.2.1/18cbf477.js">
<link rel="icon" href="../_file/observable.1af93621.png" type="image/png" sizes="32x32">
<script type="module">

import {define} from "../_observablehq/client.609bff7d.js";

define({id: "2073a86e", inputs: ["incidents","ridership","incidents_ridership_combined","currentStaffing","local_events","incidents_ridership_events_combined"], outputs: ["withIncidents","withEvents"], body: (incidents,ridership,incidents_ridership_combined,currentStaffing,local_events,incidents_ridership_events_combined) => {
// DEBUG: Check the data formats and joining
console.log("Sample incidents data:", incidents.slice(0, 3));
console.log("Sample ridership data:", ridership.slice(0, 3));
console.log("Total incidents records:", incidents.length);
console.log("Total ridership records:", ridership.length);
console.log("Combined dataset length:", incidents_ridership_combined.length);

// Check incident date/station formats
console.log("Incident dates sample:", incidents.slice(0, 5).map(d => d.date));
console.log("Incident stations sample:", incidents.slice(0, 5).map(d => d.station));
console.log("Ridership dates sample:", ridership.slice(0, 5).map(d => d.date)); 
console.log("Ridership stations sample:", ridership.slice(0, 5).map(d => d.station));

// Count records with incidents
const withIncidents = incidents_ridership_combined.filter(d => d.incident_count > 0);
console.log("Records with incidents:", withIncidents.length);
console.log("Sample combined record with incidents:", withIncidents[0]);

// DEBUG: Check staffing data specifically
console.log("Sample incident record fields:", incidents.slice(0, 1)[0]);
console.log("Available incident fields:", Object.keys(incidents[0] || {}));
console.log("Checking for staff_count field in incidents:", incidents.slice(0, 3).map(d => d.staff_count));
console.log("Current staffing object sample:", Object.entries(currentStaffing).slice(0, 3));
console.log("Staff at incident values in combined data:", withIncidents.slice(0, 3).map(d => d.staff_at_incident));

// DEBUG: Check local events data and new combined dataset
console.log("Sample local events data:", local_events.slice(0, 3));
console.log("Available local events fields:", Object.keys(local_events[0] || {}));
console.log("Local events dates sample:", local_events.slice(0, 5).map(d => d.date));
console.log("Local events nearby stations sample:", local_events.slice(0, 5).map(d => d.nearby_station));
console.log("Total local events records:", local_events.length);
console.log("New combined dataset length:", incidents_ridership_events_combined.length);

// Count records with events
const withEvents = incidents_ridership_events_combined.filter(d => d.event_count > 0);
console.log("Records with local events:", withEvents.length);
console.log("Sample record with events:", withEvents[0]);
return {withIncidents,withEvents};
}});

define({id: "7792c8a8", inputs: ["incidents_ridership_combined","Inputs"], outputs: ["recordsWithIncidents","firstIncident","secondIncident"], body: (incidents_ridership_combined,Inputs) => {
// Find the first and second incidents in the dataset
const recordsWithIncidents = incidents_ridership_combined.filter(d => d.has_incidents && d.incident_count > 0);

console.log(`Total records with incidents: ${recordsWithIncidents.length}`);

// Show the first incident
const firstIncident = recordsWithIncidents[0];
console.log("First incident record:", firstIncident);

// Show the second incident  
const secondIncident = recordsWithIncidents[1];
console.log("Second incident record:", secondIncident);

// Display both as a table
Inputs.table([firstIncident, secondIncident], {
  columns: ["date", "station", "entrances", "exits", "total_ridership", "incident_count", "staff_at_incident", "primary_severity", "has_incidents", "avg_response_time"],
  header: {
    date: "Date",
    station: "Station",
    entrances: "Entrances", 
    exits: "Exits",
    total_ridership: "Total Ridership",
    incident_count: "Incident Count",
    staff_at_incident: "Staff# at the time of Incident",
    primary_severity: "Primary Severity",
    has_incidents: "Has Incidents",
    avg_response_time: "Avg Response Time (min)"
  },
  width: {
    date: 120,
    station: 200,
    entrances: 100,
    exits: 100,
    total_ridership: 150,
    incident_count: 100,
    staff_at_incident: 180,
    primary_severity: 120,
    has_incidents: 120,
    avg_response_time: 180
  }
})
return {recordsWithIncidents,firstIncident,secondIncident};
}});

define({id: "50551e6b", inputs: ["Inputs","incidents_ridership_combined","display"], body: async (Inputs,incidents_ridership_combined,display) => {
display(await(
// Display only records with actual incidents (incident_count > 0) using Observable Framework
Inputs.table(incidents_ridership_combined.filter(d => d.incident_count > 0), {
  columns: ["date", "station", "entrances", "exits", "total_ridership", "incident_count", "staff_at_incident", "primary_severity", "has_incidents", "avg_response_time"],
  header: {
    date: "Date",
    station: "Station", 
    entrances: "Entrances",
    exits: "Exits",
    total_ridership: "Total Ridership",
    incident_count: "Incidents",
    staff_at_incident: "Staff# at the time of Incident",
    primary_severity: "Primary Severity",
    has_incidents: "Has Incidents",
    avg_response_time: "Avg Response Time (min)"
  },
  width: {
    date: 120,
    station: 200,
    entrances: 100,
    exits: 100,
    total_ridership: 150,
    incident_count: 100,
    staff_at_incident: 180,
    primary_severity: 120,
    has_incidents: 120,
    avg_response_time: 180
  },
  layout: "auto"
})
))
}});

define({id: "0e45dcd5", inputs: ["Inputs","incidents_ridership_combined","display"], body: async (Inputs,incidents_ridership_combined,display) => {
display(await(
// Display first 1000 rows of combined dataset (with or without incidents) using Observable Framework
Inputs.table(incidents_ridership_combined.slice(0, 1000), {
  columns: ["date", "station", "entrances", "exits", "total_ridership", "incident_count", "staff_at_incident", "primary_severity", "has_incidents", "avg_response_time"],
  header: {
    date: "Date",
    station: "Station", 
    entrances: "Entrances",
    exits: "Exits",
    total_ridership: "Total Ridership",
    incident_count: "Incidents",
    staff_at_incident: "Staff# at the time of Incident",
    primary_severity: "Primary Severity",
    has_incidents: "Has Incidents",
    avg_response_time: "Avg Response Time (min)"
  },
  width: {
    date: 120,
    station: 200,
    entrances: 100,
    exits: 100,
    total_ridership: 150,
    incident_count: 100,
    staff_at_incident: 180,
    primary_severity: 120,
    has_incidents: 120,
    avg_response_time: 180
  },
  layout: "auto"
})
))
}});

define({id: "c5892184", inputs: ["Inputs","incidents_ridership_events_combined","display"], body: async (Inputs,incidents_ridership_events_combined,display) => {
display(await(
// Display NEW combined dataset with local events (first 100 rows)
Inputs.table(incidents_ridership_events_combined.slice(0, 100), {
  columns: ["date", "station", "entrances", "exits", "total_ridership", "incident_count", "staff_at_incident", "primary_severity", "event_count", "total_estimated_attendance", "has_incidents", "has_events", "avg_response_time"],
  header: {
    date: "Date",
    station: "Station", 
    entrances: "Entrances",
    exits: "Exits",
    total_ridership: "Total Ridership",
    incident_count: "Incidents",
    staff_at_incident: "Staff# at the time of Incident",
    primary_severity: "Primary Severity",
    event_count: "Local Events Count",
    total_estimated_attendance: "Event Attendance",
    has_incidents: "Has Incidents",
    has_events: "Has Local Events",
    avg_response_time: "Avg Response Time (min)"
  },
  width: {
    date: 120,
    station: 200,
    entrances: 100,
    exits: 100,
    total_ridership: 150,
    incident_count: 100,
    staff_at_incident: 180,
    primary_severity: 120,
    event_count: 120,
    total_estimated_attendance: 150,
    has_incidents: 120,
    has_events: 120,
    avg_response_time: 180
  },
  layout: "auto"
})
))
}});

define({id: "271bd593", inputs: ["Inputs","incidents_ridership_events_combined","display"], body: async (Inputs,incidents_ridership_events_combined,display) => {
display(await(
// Display ONLY records with local events (event_count > 0) using Observable Framework
Inputs.table(incidents_ridership_events_combined.filter(d => d.event_count > 0), {
  columns: ["date", "station", "entrances", "exits", "total_ridership", "incident_count", "staff_at_incident", "primary_severity", "event_count", "total_estimated_attendance", "has_incidents", "has_events", "avg_response_time"],
  header: {
    date: "Date",
    station: "Station", 
    entrances: "Entrances",
    exits: "Exits",
    total_ridership: "Total Ridership",
    incident_count: "Incidents",
    staff_at_incident: "Staff# at the time of Incident",
    primary_severity: "Primary Severity",
    event_count: "Local Events Count",
    total_estimated_attendance: "Event Attendance",
    has_incidents: "Has Incidents",
    has_events: "Has Local Events",
    avg_response_time: "Avg Response Time (min)"
  },
  width: {
    date: 120,
    station: 200,
    entrances: 100,
    exits: 100,
    total_ridership: 150,
    incident_count: 100,
    staff_at_incident: 180,
    primary_severity: 120,
    event_count: 120,
    total_estimated_attendance: 150,
    has_incidents: 120,
    has_events: 120,
    avg_response_time: 180
  },
  layout: "auto"
})
))
}});

define({id: "c6dde79f", inputs: ["Inputs","incidents_ridership_events_combined","display"], body: async (Inputs,incidents_ridership_events_combined,display) => {
display(await(
// Display records with BOTH incidents (not 0) AND exactly 1 local event using Observable Framework
Inputs.table(incidents_ridership_events_combined.filter(d => d.incident_count > 0 && d.event_count === 1), {
  columns: ["date", "station", "entrances", "exits", "total_ridership", "incident_count", "staff_at_incident", "primary_severity", "event_count", "total_estimated_attendance", "has_incidents", "has_events", "avg_response_time"],
  header: {
    date: "Date",
    station: "Station", 
    entrances: "Entrances",
    exits: "Exits",
    total_ridership: "Total Ridership",
    incident_count: "Incidents",
    staff_at_incident: "Staff# at the time of Incident",
    primary_severity: "Primary Severity",
    event_count: "Local Events Count",
    total_estimated_attendance: "Event Attendance",
    has_incidents: "Has Incidents",
    has_events: "Has Local Events",
    avg_response_time: "Avg Response Time (min)"
  },
  width: {
    date: 120,
    station: 200,
    entrances: 100,
    exits: 100,
    total_ridership: 150,
    incident_count: 100,
    staff_at_incident: 180,
    primary_severity: 120,
    event_count: 120,
    total_estimated_attendance: 150,
    has_incidents: 120,
    has_events: 120,
    avg_response_time: 180
  },
  layout: "auto"
})
))
}});

define({id: "27523712", inputs: ["incidents_ridership_events_combined"], outputs: ["convertToCSV","fullCombinedCSV","incidentsOnlyCSV","eventsOnlyCSV","incidentsAndEventsCSV"], body: (incidents_ridership_events_combined) => {
// Function to convert data to CSV format
function convertToCSV(data, filename) {
  if (!data || data.length === 0) {
    return "No data available for export";
  }
  
  // Get all unique keys from the data
  const allKeys = [...new Set(data.flatMap(Object.keys))];
  
  // Filter out complex objects/arrays for CSV compatibility
  const simpleKeys = allKeys.filter(key => {
    const sampleValue = data.find(row => row[key] !== undefined)?.[key];
    return sampleValue !== null && 
           typeof sampleValue !== 'object' && 
           !Array.isArray(sampleValue);
  });
  
  // Create CSV header
  const csvHeader = simpleKeys.join(',');
  
  // Create CSV rows
  const csvRows = data.map(row => {
    return simpleKeys.map(key => {
      const value = row[key];
      // Handle values that might contain commas or quotes
      if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
        return `"${value.replace(/"/g, '""')}"`;
      }
      return value ?? '';
    }).join(',');
  });
  
  return [csvHeader, ...csvRows].join('\n');
}

// Create CSV content for the full combined dataset
const fullCombinedCSV = convertToCSV(incidents_ridership_events_combined, "full_combined_data");

// Create CSV content for records with incidents only  
const incidentsOnlyCSV = convertToCSV(
  incidents_ridership_events_combined.filter(d => d.incident_count > 0), 
  "incidents_only_data"
);

// Create CSV content for records with events only
const eventsOnlyCSV = convertToCSV(
  incidents_ridership_events_combined.filter(d => d.event_count > 0), 
  "events_only_data"
);

// Create CSV content for records with both incidents and exactly 1 event
const incidentsAndEventsCSV = convertToCSV(
  incidents_ridership_events_combined.filter(d => d.incident_count > 0 && d.event_count === 1), 
  "incidents_and_events_data"
);
return {convertToCSV,fullCombinedCSV,incidentsOnlyCSV,eventsOnlyCSV,incidentsAndEventsCSV};
}});

define({id: "fe1c40f9", mode: "inline", inputs: ["fullDataCSV","display"], body: async (fullDataCSV,display) => {
display(await(
fullDataCSV.split('\n').slice(0, 3).join('\n')
))
}});

define({id: "e54f84f4", mode: "inline", inputs: ["incidentsCSV","display"], body: async (incidentsCSV,display) => {
display(await(
incidentsCSV.split('\n').slice(0, 3).join('\n')
))
}});

define({id: "687a1fc3", mode: "inline", inputs: ["eventsCSV","display"], body: async (eventsCSV,display) => {
display(await(
eventsCSV.split('\n').slice(0, 3).join('\n')
))
}});

define({id: "5c874020", mode: "inline", inputs: ["bothCSV","display"], body: async (bothCSV,display) => {
display(await(
bothCSV.split('\n').slice(0, 3).join('\n')
))
}});

define({id: "dd79e752", mode: "inline", inputs: ["fullDataCSV","display"], body: async (fullDataCSV,display) => {
display(await(
fullDataCSV.length > 100 ? "‚úÖ Generated" : "‚ùå Empty or too small"
))
}});

define({id: "8da25ed8", mode: "inline", inputs: ["fullDataCSV","display"], body: async (fullDataCSV,display) => {
display(await(
fullDataCSV.length
))
}});

define({id: "e71afd04", mode: "inline", inputs: ["incidentsCSV","display"], body: async (incidentsCSV,display) => {
display(await(
incidentsCSV.length > 50 ? "‚úÖ Generated" : "‚ùå Empty or too small"
))
}});

define({id: "059bc2d6", mode: "inline", inputs: ["incidentsCSV","display"], body: async (incidentsCSV,display) => {
display(await(
incidentsCSV.length
))
}});

define({id: "42824cdf", mode: "inline", inputs: ["eventsCSV","display"], body: async (eventsCSV,display) => {
display(await(
eventsCSV.length > 50 ? "‚úÖ Generated" : "‚ùå Empty or too small"
))
}});

define({id: "974f48f9", mode: "inline", inputs: ["eventsCSV","display"], body: async (eventsCSV,display) => {
display(await(
eventsCSV.length
))
}});

define({id: "2c524c79", mode: "inline", inputs: ["bothCSV","display"], body: async (bothCSV,display) => {
display(await(
bothCSV.length > 50 ? "‚úÖ Generated" : "‚ùå Empty or too small"
))
}});

define({id: "fd7c3c8b", mode: "inline", inputs: ["bothCSV","display"], body: async (bothCSV,display) => {
display(await(
bothCSV.length
))
}});

define({id: "8e9b8f86", mode: "inline", inputs: ["incidents_ridership_events_combined","display"], body: async (incidents_ridership_events_combined,display) => {
display(await(
incidents_ridership_events_combined.length.toLocaleString()
))
}});

define({id: "8e9b8f86-1", mode: "inline", inputs: ["incidents_ridership_events_combined","display"], body: async (incidents_ridership_events_combined,display) => {
display(await(
incidents_ridership_events_combined.length.toLocaleString()
))
}});

define({id: "6ff37c58", mode: "inline", inputs: ["fullDataCSV","display"], body: async (fullDataCSV,display) => {
display(await(
fullDataCSV.length.toLocaleString()
))
}});

define({id: "77e68864", mode: "inline", inputs: ["fullDataCSV","display"], body: async (fullDataCSV,display) => {
display(await(
fullDataCSV.split('\\n')[0].split(',').length
))
}});

define({id: "6818b2da", mode: "inline", inputs: ["fullDataCSV","display"], body: async (fullDataCSV,display) => {
display(await(
fullDataCSV.split('\\n').length.toLocaleString()
))
}});

define({id: "1948228d", mode: "inline", inputs: ["incidents_ridership_events_combined","display"], body: async (incidents_ridership_events_combined,display) => {
display(await(
incidents_ridership_events_combined.filter(d => d.incident_count > 0).length.toLocaleString()
))
}});

</script>
</head>
<body>
<input id="observablehq-sidebar-toggle" type="checkbox" title="Toggle sidebar">
<label id="observablehq-sidebar-backdrop" for="observablehq-sidebar-toggle"></label>
<nav id="observablehq-sidebar">
  <ol>
    <label id="observablehq-sidebar-close" for="observablehq-sidebar-toggle"></label>
    <li class="observablehq-link"><a href="../">Interactive Data Visualization (Fall 2025)</a></li>
  </ol>
  <details>
    <summary>Lab 0: Getting Started</summary>
    <ol>
    <li class="observablehq-link"><a href="../lab_0/readme">Instructions</a></li>
    <li class="observablehq-link"><a href="../lab_0/">Dashboard</a></li>
    </ol>
  </details>
  <details>
    <summary>Lab 1: Prolific Pollinators</summary>
    <ol>
    <li class="observablehq-link"><a href="../lab_1/readme">Instructions</a></li>
    <li class="observablehq-link"><a href="../lab_1/">Dashboard</a></li>
    </ol>
  </details>
  <details>
    <summary>Lab 2: Subway Staffing</summary>
    <ol>
    <li class="observablehq-link"><a href="./readme">Instructions</a></li>
    <li class="observablehq-link"><a href="./">Dashboard</a></li>
    </ol>
  </details>
  <details open>
    <summary>Lab 3: Mayoral Mystery</summary>
    <ol>
    <li class="observablehq-link"><a href="../lab_3/readme">Instructions</a></li>
    <li class="observablehq-link"><a href="../lab_3/">Dashboard</a></li>
    </ol>
  </details>
  <details open>
    <summary>Lab 4: Clearwater Crisis</summary>
    <ol>
    <li class="observablehq-link"><a href="../lab_4/readme">Instructions</a></li>
    <li class="observablehq-link"><a href="../lab_4/">Dashboard</a></li>
    </ol>
  </details>
</nav>
<script>{const e=document.querySelector("#observablehq-sidebar"),o=document.querySelector("#observablehq-sidebar-toggle"),r=sessionStorage.getItem("observablehq-sidebar");r?o.checked=r==="true":o.indeterminate=!0;for(const t of document.querySelectorAll("#observablehq-sidebar summary")){const s=t.parentElement;switch(sessionStorage.getItem(`observablehq-sidebar:${t.textContent}`)){case"true":s.open=!0;break;case"false":s.classList.contains("observablehq-section-active")||(s.open=!1);break}}addEventListener("beforeunload",()=>sessionStorage.setItem("observablehq-sidebar-scrolly",`${e.scrollTop}`));const a=sessionStorage.getItem("observablehq-sidebar-scrolly");a!=null&&(e.style.cssText="overflow: hidden;",e.scrollTop=+a,e.style.cssText="");}</script>
<div id="observablehq-center">
<aside id="observablehq-toc" data-selector="h1:not(:first-of-type)[id], h2:first-child[id], :not(h1) + h2[id]">
<nav>
<div>Contents</div>
<ol>
<li class="observablehq-secondary-link"><a href="#csv-export-for-excel">CSV Export for Excel</a></li>
<li class="observablehq-secondary-link"><a href="#data-dictionary">Data Dictionary</a></li>
</ol>
</nav>
</aside>
<main id="observablehq-main" class="observablehq">
<p>This page is where you can iterate. Follow the lab instructions in the <a href="./README.md">readme.md</a>.</p>
<!-- Import Data -->
<p>const incidents = FileAttachment("./data/incidents.csv").csv({ typed: true })
const local_events = FileAttachment("./data/local_events.csv").csv({ typed: true })
const upcoming_events = FileAttachment("./data/upcoming_events.csv").csv({ typed: true })
const ridership = FileAttachment("./data/ridership.csv").csv({ typed: true })</p>
<p>incidents.slice(0,5)</p>
<p>local_events.slice(0,5)</p>
<p>upcoming_events.slice(0,5)</p>
<p>ridership.slice(0,5)</p>
<!-- Include current staffing counts from the prompt -->
<p>const currentStaffing = {
"Times Sq-42 St": 19,
"Grand Central-42 St": 18,
"34 St-Penn Station": 15,
"14 St-Union Sq": 4,
"Fulton St": 17,
"42 St-Port Authority": 14,
"Herald Sq-34 St": 15,
"Canal St": 4,
"59 St-Columbus Circle": 6,
"125 St": 7,
"96 St": 19,
"86 St": 19,
"72 St": 10,
"66 St-Lincoln Center": 15,
"50 St": 20,
"28 St": 13,
"23 St": 8,
"Christopher St": 15,
"Houston St": 18,
"Spring St": 12,
"Chambers St": 18,
"Wall St": 9,
"Bowling Green": 6,
"West 4 St-Wash Sq": 4,
"Astor Pl": 7
}</p>
<!-- Combine incidents with ridership data using date and station as keys -->
<p>// Create a combined dataset joining incidents and ridership by date and station
const incidents_ridership_combined = Array.from(
d3.group(ridership, d =&gt; <code>${d.date}_${d.station}</code>),
([key, ridership_records]) =&gt; {
const [date, station] = key.split('_');</p>
<pre><code>// Find matching incidents for this date and station with more flexible matching
const matching_incidents = incidents.filter(incident =&gt; {
  const incidentDate = incident.date ? incident.date.toString().trim() : "";
  const incidentStation = incident.station ? incident.station.toString().trim() : "";
  const ridershipDate = date ? date.toString().trim() : "";
  const ridershipStation = station ? station.toString().trim() : "";
  
  return incidentStation === ridershipStation &amp;&amp; incidentDate === ridershipDate;
});

// Get ridership data (should be one record per date-station)
const ridership_data = ridership_records[0];

// Combine the data
return {
  date: date,
  station: station,
  entrances: ridership_data.entrances,
  exits: ridership_data.exits,
  total_ridership: ridership_data.entrances + ridership_data.exits,
  incident_count: matching_incidents.length,
  incidents: matching_incidents,
  has_incidents: matching_incidents.length &gt; 0,
  // Calculate incident statistics if there are incidents
  avg_response_time: matching_incidents.length &gt; 0 ? 
    d3.mean(matching_incidents, d =&gt; d.response_time_minutes) : null,
  // Add severity information
  severities: matching_incidents.map(d =&gt; d.severity), // Array of all severities for this date-station
  primary_severity: matching_incidents.length &gt; 0 ? 
    matching_incidents.reduce((prev, current) =&gt; {
      // Prioritize high &gt; medium &gt; low
      const priority = { high: 3, medium: 2, low: 1 };
      return (priority[current.severity] || 0) &gt; (priority[prev.severity] || 0) ? current : prev;
    }).severity : null,
  // Add staffing information from incidents
  staff_at_incident: matching_incidents.length &gt; 0 ? 
    (matching_incidents[0].staff_count || matching_incidents[0].staffing || matching_incidents[0].staff || currentStaffing[station]) : 
    currentStaffing[station] || null,
  severity_counts: {
    high: matching_incidents.filter(d =&gt; d.severity === 'high').length,
    medium: matching_incidents.filter(d =&gt; d.severity === 'medium').length,
    low: matching_incidents.filter(d =&gt; d.severity === 'low').length
  }
};
</code></pre>
<p>}
).filter(d =&gt; d.date &amp;&amp; d.station) // Remove any invalid records</p>
<p>// Create a NEW combined dataset that includes local events data
const incidents_ridership_events_combined = incidents_ridership_combined.map(record =&gt; {
// DEBUG: Let's check what fields are actually available in local events
if (Math.random() &lt; 0.001) { // Log occasionally to avoid spam
console.log("Sample local event record:", local_events[0]);
console.log("Local events fields:", Object.keys(local_events[0] || {}));
}</p>
<p>// Find matching local events for this date and station
// Try multiple possible field name combinations
const matching_events = local_events.filter(event =&gt; {
const eventDate = event.date || event.event_date || "";
const eventStation = event.nearby_station || event.station || event.station_name || "";
const recordDate = record.date || "";
const recordStation = record.station || "";</p>
<pre><code>// Convert to strings and normalize
const eDateStr = eventDate.toString().trim().toLowerCase();
const eStationStr = eventStation.toString().trim().toLowerCase();
const rDateStr = recordDate.toString().trim().toLowerCase();
const rStationStr = recordStation.toString().trim().toLowerCase();

const dateMatch = eDateStr === rDateStr;
const stationMatch = eStationStr === rStationStr;

// Debug matching occasionally
if (Math.random() &lt; 0.001 &amp;&amp; (dateMatch || stationMatch)) {
  console.log("Potential match found:", {
    eventDate: eDateStr, recordDate: rDateStr, dateMatch,
    eventStation: eStationStr, recordStation: rStationStr, stationMatch
  });
}

return dateMatch &amp;&amp; stationMatch;
</code></pre>
<p>});</p>
<p>// Add local events information to the existing record
return {
...record, // Keep all existing fields
// Add event-related fields
event_count: matching_events.length,
has_events: matching_events.length &gt; 0,
events: matching_events,
total_estimated_attendance: matching_events.length &gt; 0 ?
d3.sum(matching_events, d =&gt; d.estimated_attendance || d.attendance || d.expected_attendance || 0) : 0,
event_types: matching_events.map(d =&gt; d.event_type || d.type || d.category || "Unknown"),
nearby_station: matching_events.length &gt; 0 ?
(matching_events[0].nearby_station || matching_events[0].station || matching_events[0].station_name) : record.station
};
})</p>
<pre><code>
```js
// SPECIFIC DEBUG: Local Events Analysis
console.log("=== LOCAL EVENTS DEBUG ===");
console.log("Total local_events records:", local_events.length);
console.log("First 3 local events:", local_events.slice(0, 3));
console.log("Local events field names:", Object.keys(local_events[0] || {}));

// Check specific field names and values
console.log("Local events dates (first 10):", local_events.slice(0, 10).map(d =&gt; d.date || d.event_date || "NO_DATE"));
console.log("Local events stations (first 10):", local_events.slice(0, 10).map(d =&gt; d.nearby_station || d.station || d.station_name || "NO_STATION"));
console.log("Local events attendance (first 10):", local_events.slice(0, 10).map(d =&gt; d.estimated_attendance || d.attendance || "NO_ATTENDANCE"));

// Check date and station formats from both datasets
console.log("Sample ridership dates:", ridership.slice(0, 5).map(d =&gt; d.date));
console.log("Sample ridership stations:", ridership.slice(0, 5).map(d =&gt; d.station));

// Test manual matching
const testRecord = incidents_ridership_combined[0];
console.log("Test record for matching:", testRecord);
const testMatches = local_events.filter(event =&gt; {
  const eventDate = (event.date || event.event_date || "").toString().trim().toLowerCase();
  const eventStation = (event.nearby_station || event.station || event.station_name || "").toString().trim().toLowerCase();
  const recordDate = (testRecord.date || "").toString().trim().toLowerCase();
  const recordStation = (testRecord.station || "").toString().trim().toLowerCase();
  return eventDate === recordDate &amp;&amp; eventStation === recordStation;
});
console.log("Manual test matches for first record:", testMatches.length);

// Check if any events have matching stations (ignore date for now)
const stationMatches = local_events.filter(event =&gt; {
  const eventStation = (event.nearby_station || event.station || event.station_name || "").toString().trim().toLowerCase();
  return incidents_ridership_combined.some(record =&gt; 
    (record.station || "").toString().trim().toLowerCase() === eventStation
  );
});
console.log("Events with matching stations (any date):", stationMatches.length);
</code></pre>
<div class="observablehq observablehq--block"><!--:2073a86e:--></div>
<div class="observablehq observablehq--block"><!--:7792c8a8:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:50551e6b:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:0e45dcd5:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:c5892184:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:271bd593:--></div>
<div class="observablehq observablehq--block"><observablehq-loading></observablehq-loading><!--:c6dde79f:--></div>
<h2 id="csv-export-for-excel" tabindex="-1"><a class="observablehq-header-anchor" href="#csv-export-for-excel">CSV Export for Excel</a></h2>
<p>Create downloadable CSV files of your combined datasets:</p>
<div class="observablehq observablehq--block"><!--:27523712:--></div>
<p>// Simple CSV export using Observable Framework's built-in capabilities
// Create CSV content for each dataset
function arrayToCSV(data) {
if (!data || data.length === 0) return "No data available";</p>
<p>// Get headers (only simple data types)
const headers = Object.keys(data[0]).filter(key =&gt; {
const value = data[0][key];
return typeof value !== 'object' || value === null;
});</p>
<p>// Create CSV rows
const rows = data.map(row =&gt;
headers.map(header =&gt; {
let value = row[header];
if (value === null || value === undefined) value = '';
if (typeof value === 'string' &amp;&amp; (value.includes(',') || value.includes('"'))) {
value = <code>"${value.replace(/"/g, '""')}"</code>;
}
return value;
}).join(',')
);</p>
<p>return [headers.join(','), ...rows].join('\n');
}</p>
<p>// Create the CSV data
const fullDataCSV = arrayToCSV(incidents_ridership_events_combined);
const incidentsCSV = arrayToCSV(incidents_ridership_events_combined.filter(d =&gt; d.incident_count &gt; 0));
const eventsCSV = arrayToCSV(incidents_ridership_events_combined.filter(d =&gt; d.event_count &gt; 0));
const bothCSV = arrayToCSV(incidents_ridership_events_combined.filter(d =&gt; d.incident_count &gt; 0 &amp;&amp; d.event_count === 1));</p>
<p>// DEBUG: Log CSV creation status
console.log("=== CSV FILE CREATION STATUS ===");
console.log("Full dataset CSV length:", fullDataCSV.length, "characters");
console.log("Full dataset preview (first 200 chars):", fullDataCSV.substring(0, 200) + "...");
console.log("Incidents CSV length:", incidentsCSV.length, "characters");
console.log("Events CSV length:", eventsCSV.length, "characters");<br>
console.log("Both CSV length:", bothCSV.length, "characters");
console.log("Data URI lengths:");
console.log("- Full:", <code>data:text/csv;charset=utf-8,${encodeURIComponent(fullDataCSV)}</code>.length);
console.log("- Incidents:", <code>data:text/csv;charset=utf-8,${encodeURIComponent(incidentsCSV)}</code>.length);
console.log("- Events:", <code>data:text/csv;charset=utf-8,${encodeURIComponent(eventsCSV)}</code>.length);
console.log("- Both:", <code>data:text/csv;charset=utf-8,${encodeURIComponent(bothCSV)}</code>.length);</p>
<p>// CSV Preview - Show first few lines of each CSV to verify content
html`</p>
<div style="background: #fff3cd; padding: 15px; border-radius: 6px; border: 1px solid #ffeaa7; margin: 15px 0;">
  <h4 style="color: #856404; margin-top: 0;">üîç CSV Content Verification</h4>
  <p style="color: #856404; font-size: 14px;">Preview the first few lines of each CSV file to verify they were created correctly:</p>
  <div style="font-family: monospace; font-size: 12px; background: white; padding: 10px; border-radius: 4px; margin: 10px 0; border: 1px solid #ddd;">
    <strong>Full Dataset (first 3 lines):</strong><br>
    <pre style="margin: 5px 0; white-space: pre-wrap; word-wrap: break-word;"><observablehq-loading></observablehq-loading><!--:fe1c40f9:--></pre>
  </div>
  <div style="font-family: monospace; font-size: 12px; background: white; padding: 10px; border-radius: 4px; margin: 10px 0; border: 1px solid #ddd;">
    <strong>Incidents Only (first 3 lines):</strong><br>
    <pre style="margin: 5px 0; white-space: pre-wrap; word-wrap: break-word;"><observablehq-loading></observablehq-loading><!--:e54f84f4:--></pre>
  </div>
  <div style="font-family: monospace; font-size: 12px; background: white; padding: 10px; border-radius: 4px; margin: 10px 0; border: 1px solid #ddd;">
    <strong>Events Only (first 3 lines):</strong><br>
    <pre style="margin: 5px 0; white-space: pre-wrap; word-wrap: break-word;"><observablehq-loading></observablehq-loading><!--:687a1fc3:--></pre>
  </div>
  <div style="font-family: monospace; font-size: 12px; background: white; padding: 10px; border-radius: 4px; margin: 10px 0; border: 1px solid #ddd;">
    <strong>Incidents + Events (first 3 lines):</strong><br>
    <pre style="margin: 5px 0; white-space: pre-wrap; word-wrap: break-word;"><observablehq-loading></observablehq-loading><!--:5c874020:--></pre>
  </div>
  <div style="margin-top: 15px; padding: 10px; background: #d1ecf1; border-radius: 4px; border-left: 4px solid #bee5eb;">
    <strong>‚úÖ Status Check:</strong>
    <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
      <li>Full Dataset: <observablehq-loading></observablehq-loading><!--:dd79e752:--> (<observablehq-loading></observablehq-loading><!--:8da25ed8:--> chars)</li>
      <li>Incidents: <observablehq-loading></observablehq-loading><!--:e71afd04:--> (<observablehq-loading></observablehq-loading><!--:059bc2d6:--> chars)</li>
      <li>Events: <observablehq-loading></observablehq-loading><!--:42824cdf:--> (<observablehq-loading></observablehq-loading><!--:974f48f9:--> chars)</li>
      <li>Both: <observablehq-loading></observablehq-loading><!--:2c524c79:--> (<observablehq-loading></observablehq-loading><!--:fd7c3c8b:--> chars)</li>
    </ul>
  </div>
</div>
`
<p>// Display the download interface with data URIs
html`</p>
<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
  <h3 style="color: #495057; margin-top: 0;">üìÅ Download CSV Files for Excel</h3>
  <p style="color: #6c757d; margin-bottom: 20px;">Right-click and "Save link as..." to download CSV files:</p>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
<pre><code>&lt;div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef;"&gt;
  &lt;h4 style="color: #007bff; margin: 0 0 8px 0;"&gt;üìä Full Combined Dataset&lt;/h4&gt;
  &lt;p style="color: #6c757d; font-size: 14px; margin: 0 0 12px 0;"&gt;
    ${incidents_ridership_events_combined.length.toLocaleString()} total records&lt;br&gt;
    &lt;small&gt;Complete dataset with all information&lt;/small&gt;
  &lt;/p&gt;
  &lt;a href="data:text/csv;charset=utf-8,${encodeURIComponent(fullDataCSV)}" 
     download="subway_full_combined_data.csv"
     style="display: inline-block; background: #007bff; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; width: calc(100% - 32px); text-align: center;"&gt;
    üì• Download Full Dataset
  &lt;/a&gt;
&lt;/div&gt;

&lt;div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef;"&gt;
  &lt;h4 style="color: #dc3545; margin: 0 0 8px 0;"&gt;üö® Incidents Only&lt;/h4&gt;
  &lt;p style="color: #6c757d; font-size: 14px; margin: 0 0 12px 0;"&gt;
    ${incidents_ridership_events_combined.filter(d =&gt; d.incident_count &gt; 0).length.toLocaleString()} records with incidents&lt;br&gt;
    &lt;small&gt;Safety incidents and response data&lt;/small&gt;
  &lt;/p&gt;
  &lt;a href="data:text/csv;charset=utf-8,${encodeURIComponent(incidentsCSV)}" 
     download="subway_incidents_only.csv"
     style="display: inline-block; background: #dc3545; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; width: calc(100% - 32px); text-align: center;"&gt;
    üì• Download Incidents
  &lt;/a&gt;
&lt;/div&gt;

&lt;div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef;"&gt;
  &lt;h4 style="color: #28a745; margin: 0 0 8px 0;"&gt;üéâ Local Events Only&lt;/h4&gt;
  &lt;p style="color: #6c757d; font-size: 14px; margin: 0 0 12px 0;"&gt;
    ${incidents_ridership_events_combined.filter(d =&gt; d.event_count &gt; 0).length.toLocaleString()} records with events&lt;br&gt;
    &lt;small&gt;Local events impact analysis&lt;/small&gt;
  &lt;/p&gt;
  &lt;a href="data:text/csv;charset=utf-8,${encodeURIComponent(eventsCSV)}" 
     download="subway_events_only.csv"
     style="display: inline-block; background: #28a745; color: white; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; width: calc(100% - 32px); text-align: center;"&gt;
    üì• Download Events
  &lt;/a&gt;
&lt;/div&gt;

&lt;div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef;"&gt;
  &lt;h4 style="color: #ffc107; margin: 0 0 8px 0;"&gt;‚ö° Incidents + Events&lt;/h4&gt;
  &lt;p style="color: #6c757d; font-size: 14px; margin: 0 0 12px 0;"&gt;
    ${incidents_ridership_events_combined.filter(d =&gt; d.incident_count &gt; 0 &amp;&amp; d.event_count === 1).length.toLocaleString()} records&lt;br&gt;
    &lt;small&gt;Both incidents and events&lt;/small&gt;
  &lt;/p&gt;
  &lt;a href="data:text/csv;charset=utf-8,${encodeURIComponent(bothCSV)}" 
     download="subway_incidents_and_events.csv"
     style="display: inline-block; background: #ffc107; color: #212529; padding: 8px 16px; border-radius: 4px; text-decoration: none; font-size: 14px; width: calc(100% - 32px); text-align: center;"&gt;
    üì• Download Combined
  &lt;/a&gt;
&lt;/div&gt;
</code></pre>
  </div>
  <div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-radius: 4px; border-left: 4px solid #007bff;">
    <strong>üí° How to download:</strong>
    <ul style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
      <li><strong>Left-click:</strong> Opens download dialog (most browsers)</li>
      <li><strong>Right-click ‚Üí "Save link as":</strong> Choose download location</li>
      <li><strong>Files open directly in Excel</strong> for immediate analysis</li>
    </ul>
  </div>
</div>
`
```
<p>// ALTERNATIVE: Copy-Paste CSV Content for Excel
// If downloads don't work, you can copy this text directly into Excel
html`</p>
<div style="background: #fff; border: 2px solid #28a745; border-radius: 8px; padding: 20px; margin: 20px 0;">
  <h3 style="color: #28a745; margin-top: 0;">üìã Alternative: Copy-Paste CSV Data</h3>
  <p style="color: #495057;">If the download buttons don't work, you can copy the CSV content below and paste it directly into Excel:</p>
  <div style="margin: 15px 0;">
    <h4 style="color: #007bff;">üìä COMPLETE Combined Dataset (ALL <observablehq-loading></observablehq-loading><!--:8e9b8f86:--> rows)</h4>
    <div style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 10px; border-left: 4px solid #ffc107;">
      <strong>‚ö†Ô∏è Large Dataset Warning:</strong> This contains the entire combined dataset. It may take a few seconds to copy.
    </div>
    <button onclick="navigator.clipboard.writeText(\`${fullDataCSV}\`); alert('COMPLETE CSV data copied to clipboard! (' + ${fullDataCSV.split('\\n').length} + ' rows)')" style="background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 4px; margin-bottom: 10px; cursor: pointer; font-weight: bold;">
      üìã Copy ENTIRE Dataset to Clipboard (<observablehq-loading></observablehq-loading><!--:8e9b8f86-1:--> rows)
    </button>
    <div style="font-size: 12px; color: #6c757d; margin-bottom: 10px;">
      <strong>Dataset size:</strong> <observablehq-loading></observablehq-loading><!--:6ff37c58:--> characters | 
      <strong>Columns:</strong> <observablehq-loading></observablehq-loading><!--:77e68864:--> | 
      <strong>Rows:</strong> <observablehq-loading></observablehq-loading><!--:6818b2da:-->
    </div>
    <textarea readonly="" style="width: 100%; height: 200px; font-family: monospace; font-size: 10px; background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px;" onclick="this.select(); document.execCommand('copy'); alert('COMPLETE CSV content copied!')">${fullDataCSV}
    </textarea>
  </div>
  <div style="margin: 15px 0;">
    <h4 style="color: #dc3545;">üö® Complete Incidents Dataset (ALL incidents)</h4>
    <button onclick="navigator.clipboard.writeText(\`${incidentsCSV}\`); alert('Complete incidents CSV copied to clipboard!')" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-bottom: 10px; cursor: pointer;">
      üìã Copy ALL Incidents to Clipboard (<observablehq-loading></observablehq-loading><!--:1948228d:--> rows)
    </button>
    <textarea readonly="" style="width: 100%; height: 120px; font-family: monospace; font-size: 10px; background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px;" onclick="this.select(); document.execCommand('copy'); alert('Complete incidents CSV content copied!')">${incidentsCSV}
    </textarea>
  </div>
  <div style="background: #e7f3ff; padding: 15px; border-radius: 6px; border-left: 4px solid #007bff;">
    <h5 style="margin-top: 0; color: #007bff;">üìù How to use in Excel:</h5>
    <ol style="margin: 5px 0; padding-left: 20px; font-size: 14px;">
      <li>Click "Copy to Clipboard" button above</li>
      <li>Open Excel and create a new worksheet</li>
      <li>Click on cell A1</li>
      <li>Press Ctrl+V to paste the data</li>
      <li>Excel should automatically separate the columns</li>
      <li>If needed: Data ‚Üí Text to Columns ‚Üí Delimited ‚Üí Comma</li>
    </ol>
  </div>
</div>
`
<h2 id="data-dictionary" tabindex="-1"><a class="observablehq-header-anchor" href="#data-dictionary">Data Dictionary</a></h2>
<p>The combined dataset contains the following columns:</p>
<p>// Column descriptions for incidents_ridership_combined dataset
const columnDescriptions = [
{
column: "date",
description: "Date of the ridership data (YYYY-MM-DD format)",
type: "String",
example: "2024-01-15"
},
{
column: "station",
description: "Name of the subway station or station complex",
type: "String",
example: "14 St-Union Sq"
},
{
column: "entrances",
description: "Number of daily entrances at this station",
type: "Number",
example: "25234"
},
{
column: "exits",
description: "Number of daily exits at this station",
type: "Number",
example: "23456"
},
{
column: "total_ridership",
description: "Total daily ridership (entrances + exits)",
type: "Number",
example: "48690"
},
{
column: "incident_count",
description: "Total number of incidents at this station on this date (0 if no incidents)",
type: "Number",
example: "2"
},
{
column: "has_incidents",
description: "Boolean indicating if any incidents occurred at this station on this date",
type: "Boolean",
example: "true/false"
},
{
column: "avg_response_time",
description: "Average emergency response time in minutes for incidents on this date (null if no incidents)",
type: "Number",
example: "12.5"
},
{
column: "staff_at_incident",
description: "Number of staff members present at the station during the time of incident (from incident data or current staffing)",
type: "Number",
example: "15"
},
{
column: "primary_severity",
description: "The highest severity level among all incidents for this date-station (high &gt; medium &gt; low)",
type: "String",
example: "high"
},
{
column: "severities",
description: "Array of all severity levels for incidents on this date-station",
type: "Array",
example: "['high', 'medium']"
},
{
column: "incidents",
description: "Array of full incident objects for this date and station",
type: "Array",
example: "[{incident details...}]"
},
{
column: "severity_counts",
description: "Object with counts of incidents by severity level (high, medium, low)",
type: "Object",
example: "{high: 1, medium: 1, low: 0}"
},
{
column: "event_count",
description: "Number of local events occurring near this station on this date",
type: "Number",
example: "2"
},
{
column: "has_events",
description: "Boolean indicating if any local events occurred near this station on this date",
type: "Boolean",
example: "true/false"
},
{
column: "total_estimated_attendance",
description: "Total estimated attendance for all local events near this station on this date",
type: "Number",
example: "15000"
},
{
column: "event_types",
description: "Array of event types occurring near this station on this date",
type: "Array",
example: "['Concert', 'Sports Event']"
},
{
column: "events",
description: "Array of full local event objects for this date and nearby station",
type: "Array",
example: "[{event details...}]"
}
];</p>
</main>
<footer id="observablehq-footer">
<div>Built with <a href="https://observablehq.com/" target="_blank" rel="noopener noreferrer">Observable</a> on <a title="2025-12-19T01:24:09">Dec 19, 2025</a>.</div>
</footer>
</div>
</body>
</html>
